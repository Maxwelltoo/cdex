
# Introduction

CDEX（/ˈsiːˌdeks/ Compact Data Exchange）是一个自定义通信协议，目标是实现高效、可扩展、按需编码、可转换为 JSON 的紧凑编码，适用于包括 Zigbee 在内的带宽受限链路传输。

一个有效的 CDEX 包由如下部分组成：

| Field         | Length    | Description |
| ------------- | --------- | ----------- |
| Descriptor ID | 2 bytes   | 描述字符串的 ID   |
| Data Bitmap   | 1~8 bytes | 指示哪些数据存在    |
| Data List     | Variable  | 保存数据字段值     |
| Checksum      | 2 bytes   | CRC16 校验和   |

CDEX 通过引入 **Descriptor** 描述数据元信息、**Bitmap** 标记数据位置信息，实现了比 TLV 更高的编码效率、比位置硬编码更高的灵活性和扩展性。

# Fields

## Descriptor ID


**Descriptor** 即 **描述字符串**，包含了用 `,` 号分隔的最多 64 个段，例如 *"14.61.85-f,14.62.85-u8,14.63.85-u16"*，每一个段形式上都是 *"JSON字段名称-传输值类型"*，可以方便地保存在一个 CSV 文件中，易于查看、交换、在编解码端保持一致。

*传输值类型* 是一个简短的、可以和 C 类型对应的字符串，可选值包括：`u8`、`i8`、`u16`、`i16`、`u32`、`i32`、`u64`、`i64`、`f32`、`d64`、`str`。

每一个 **Descriptor** 的 ID 可以是 CSV 的行号，也可以是一个自定义的值，编解码方保持一致即可，使用时可以硬编码到代码中，也可以动态地从 CSV 文件解析。

## Data Bitmap

指示当前数据包中存在哪些数据，长度取决于 **描述字符串** 中段的数量，最多 64 bits，从低到高位与 **描述字符串** 中的段按顺序一一对应，如果 **Bitmap** 中的第 N 位被置 1，则描述字符串中第 N 个数据段存在。

**Bitmap** 长度应当取整为 8 的整数倍，例如，当 **描述字符串** 中有 34 个段时，**Bitmap** 为 40 bits，有 3 个段时则为 8 bits。

## Data List

实际的数据字段值，需要结合 **BitMap** 和 **描述字符串** 进行解析和转换，例如，**Bitmap** 为 0b0010'0110 时，Data List 中的第 1 个数据需要按 **描述字符串** 的第 2 个段进行解析，第 2 个数据按第 3 个段解析、第 3 个数据则按第 6 个段解析。


# Usage

## 描述符管理

描述字符串可以预定义并硬编码到代码里，也可以在运行时动态创建，由 Descriptor ID 的最高位决定，预定义的描述字符串的 ID 最高位始终为 0，而动态创建的 ID 最高位则为 1。

## 编解码

